<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="Notepad.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Notepad"
    xmlns:editor="using:WinUIEditor"
    xmlns:models="using:Notepad.Models"
    Title="Notepad">

    <Grid x:Name="MainGrid" Background="Transparent">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Focus trap: catches stray focus and redirects to editor -->
        <Button x:Name="FocusTrap" Width="0" Height="0" Opacity="0" 
                GotFocus="FocusTrap_GotFocus" IsTabStop="True"/>

        <!-- Custom Title Bar with integrated Menu -->
        <Grid x:Name="AppTitleBar" Grid.Row="0" Height="32" Background="Transparent">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Image x:Name="TitleBarIcon" Width="16" Height="16" Margin="12,0,4,0" VerticalAlignment="Center"/>
            
            <!-- Menu Bar in Title Bar -->
            <MenuBar x:Name="MainMenuBar" Grid.Column="1" VerticalAlignment="Center">
            <MenuBarItem Title="File">
                <MenuFlyoutItem Text="New Tab" Click="NewTab_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="N"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutItem Text="Open..." Click="Open_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="O"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutItem Text="Save" Click="Save_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="S"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutItem Text="Save As..." Click="SaveAs_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control,Shift" Key="S"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutSeparator/>
                <MenuFlyoutItem Text="Close Tab" Click="CloseTab_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="W"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
            </MenuBarItem>
            <MenuBarItem Title="Edit">
                <MenuFlyoutItem Text="Undo" Click="Undo_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="Z"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutItem Text="Redo" Click="Redo_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="Y"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutSeparator/>
                <MenuFlyoutItem Text="Cut" Click="Cut_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="X"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutItem Text="Copy" Click="Copy_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="C"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutItem Text="Paste" Click="Paste_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="V"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutItem Text="Select All" Click="SelectAll_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Modifiers="Control" Key="A"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
            </MenuBarItem>
            <MenuBarItem Title="View">
                <ToggleMenuFlyoutItem x:Name="WordWrapToggle" Text="Word Wrap" Click="WordWrap_Click" IsChecked="False"/>
                <ToggleMenuFlyoutItem x:Name="LineNumbersToggle" Text="Line Numbers" Click="LineNumbers_Click" IsChecked="True"/>
                <ToggleMenuFlyoutItem x:Name="StatusBarToggle" Text="Status Bar" Click="StatusBar_Click" IsChecked="True"/>
                <MenuFlyoutSeparator/>
                <MenuFlyoutSubItem Text="Theme">
                    <MenuFlyoutItem x:Name="ThemeAuto" Text="Auto" Click="ThemeAuto_Click"/>
                    <MenuFlyoutItem x:Name="ThemeDark" Text="Dark" Click="ThemeDark_Click"/>
                    <MenuFlyoutItem x:Name="ThemeLight" Text="Light" Click="ThemeLight_Click"/>
                </MenuFlyoutSubItem>
            </MenuBarItem>
            <!-- Go menu will be added by plugins -->
            </MenuBar>
            
            <!-- Draggable title area -->
            <Border x:Name="DragRegion" Grid.Column="2" Background="Transparent"/>
        </Grid>

        <!-- Tab View with Find/Replace overlay -->
        <Grid x:Name="TabContentGrid" Grid.Row="1">
            <TabView x:Name="TabViewControl"
                     AddTabButtonClick="TabView_AddTabButtonClick"
                     TabCloseRequested="TabView_TabCloseRequested"
                     SelectionChanged="TabView_SelectionChanged"
                     TabItemsChanged="TabView_TabItemsChanged"
                     IsAddTabButtonVisible="True"
                     TabWidthMode="Equal"
                     CanDragTabs="True"
                     CanReorderTabs="True"
                     VerticalAlignment="Stretch"
                     HorizontalAlignment="Stretch">
                <TabView.TabStripHeader>
                    <Grid Padding="8,0,0,0"/>
                </TabView.TabStripHeader>
                <TabView.Resources>
                    <x:Double x:Key="TabViewItemHeaderMinHeight">28</x:Double>
                    <Thickness x:Key="TabViewHeaderPadding">0</Thickness>
                </TabView.Resources>
            </TabView>
            <!-- Plugin controls will be added here dynamically -->
        </Grid>

        <!-- Status Bar -->
        <Grid x:Name="StatusBar" Grid.Row="2" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
              Padding="12,4" BorderThickness="0,1,0,0" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <Button x:Name="FilePathButton" Grid.Column="0" VerticalAlignment="Center"
                    Background="Transparent" BorderThickness="0" Padding="4,2"
                    CornerRadius="4" HorizontalContentAlignment="Left"
                    IsTabStop="False">
                <Button.Resources>
                    <StaticResource x:Key="ButtonBackgroundPointerOver" ResourceKey="SubtleFillColorSecondaryBrush"/>
                    <StaticResource x:Key="ButtonBackgroundPressed" ResourceKey="SubtleFillColorTertiaryBrush"/>
                </Button.Resources>
                <TextBlock x:Name="FilePathText" 
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12"/>
                <Button.Flyout>
                    <MenuFlyout>
                        <MenuFlyoutItem x:Name="CopyPathItem" Text="Copy Path" Click="CopyPath_Click"/>
                        <MenuFlyoutItem x:Name="CopyPathLocationItem" Text="Copy Path and Location" Click="CopyPathLocation_Click"/>
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutItem x:Name="OpenDirectoryItem" Text="Open Directory" Click="OpenDirectory_Click"/>
                    </MenuFlyout>
                </Button.Flyout>
            </Button>
            
            <TextBlock x:Name="LineColumnText" Grid.Column="1" VerticalAlignment="Center" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12" Margin="24,0,0,0"
                       Text="Ln 1, Col 1"/>
            
            <TextBlock x:Name="CharCountText" Grid.Column="2" VerticalAlignment="Center" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12" Margin="24,0,0,0"/>
            
            <TextBlock x:Name="EncodingText" Grid.Column="3" VerticalAlignment="Center" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12" Margin="24,0,0,0"
                       Text="UTF-8"/>
        </Grid>

        <!-- Custom Tab Tooltip Popup -->
        <Popup x:Name="TabTooltipPopup" IsLightDismissEnabled="False" ShouldConstrainToRootBounds="False">
            <Border Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="12,8">
                <Border.Shadow>
                    <ThemeShadow/>
                </Border.Shadow>
                <ContentPresenter x:Name="TabTooltipContent" MaxWidth="500"/>
            </Border>
        </Popup>
        
        <!-- Plugin overlays will be added to MainGrid dynamically -->
    </Grid>
</Window>
